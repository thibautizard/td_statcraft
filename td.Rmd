---
title: "TD Prise en main Statcraft"
output: 
  html_document:
    toc: true
    toc_float: true
    author: Thibaut Izard
    date: Sys.Date()
  pdf_document: true
params:
  data: "Statcraft"
---

```{r setup, include=FALSE}

# Packages
library(lubridate)
library(stringi)
library(glue)
library(highcharter)
library(dplyr)

# Options
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_TIME", "fr_FR.UTF-8")

dir_data <- "."
data     <- list()

# Fonctions
explicite_date <- function(x) paste(mday(x), month(x, label=T, abbr=F), year(x))

# Layout
graphique_options <- list(title = list(align="left", style=list(fontFamily='Alegreya Sans SC')))

# Graphique
generer_graphique <- function(chart) {
  
  # Initialisation
  hc    <- highchart()
  
  # Ajout des s√©ries
 for(serie in chart$series) {
   
   cols <- colnames(serie$data)
   x_name <- cols[1]
   y_name <- cols[2]
   
    hc <- hc_add_series(hc,
                      data=serie$data,
                      type=serie$type,
                      name=serie$name,
                      hcaes(x=!!x_name, y=!!y_name)
                    )
   
 }
      
  # Tooltip
  hc <- hc  %>%
        hc_plotOptions(
          pie = list(
            tooltip = list(
              valueSuffix="%"
            )
          )
        )

  # Title
  hc <- do.call(hc_title, c(list(hc=hc),
                             chart$title['text'],
                             graphique_options$title))

  # Colors
  if(!is.null(chart$colors)) hc <- hc %>% hc_colors(chart$colors)
  # Size
  if(!is.null(chart$size)) hc <- hc %>% hc_size(height = chart$size$height, width=chart$size$width)

  # Credits
  if(!is.null(chart$credits)) hc <- do.call(hc_credits, c(list(hc=hc), chart$credits))

  return(hc)
  
}


# Calcul des pics

calculer_pics <- function(data, 
                          seuil, 
                          color_bar="#FF0000", 
                          color_text="gray") {

mediane_mois <- data %>% group_by(month(date)) %>% summarize(vues=median(vues))
pics         <- data %>% filter(vues > (mediane_mois[month(date),]$vues)*seuil) %>% group_by(month(date)) %>% top_n(1, vues)


lines <- apply(pics, 
               MARGIN=1, 
               FUN=function(pic) {
                  
              delta <- round((as.integer(pic['vues'])*100/mediane_mois[month(pic['date']),]$vues))-100
              x_position <- match(pic['date'], data$date)
              
              list(
                label = list(text = glue("Pic du  {explicite_date(pic['date'])} (+{delta}%)*"),
                             style=list(color=color_text, fontSize="10px")),
                color = color_bar,
                width = 1,
                value = x_position
                )
            })

return(lines)

}

```

```{css, echo=FALSE}

p {
  text-align:justify;
}

h1.title {
    font-size: 48px;
    font-weight: bold;
}

h1, h2, h3, h4, h5, h6 {
  font-family:'Alegreya Sans SC'
}

.html-widget {
    margin: 20px 0;
}

/* ENCART */

.encart  {

  background: #f3fff3;
  width: 90%;
  margin: 40px auto;
  padding: 20px;
  border-radius: 20px;
  border: 3px solid #008600;
  position: relative;
  overflow:hidden;
}

.encart h3 {
  
  margin: 0 0 20px 0;
  text-align: center;
  font-size: 3rem;
  
}

.encart img {
    position: absolute;
    width: 278px;
    opacity: .07;
    top: -107px;
    left: -74px;
}

.encart img:nth-of-type(2) {
  transform:translateX(65%)
}


```

## Pr√©requis

+ T√©l√©charge et installe R [lien](https://cran.r-project.org/bin/windows/base/R-4.2.0-win.exe)
+ T√©l√©charge et installe Rstudio [lien](https://download1.rstudio.org/desktop/windows/RStudio-2022.02.3-492.exe)
+ T√©l√©charge le zip contenant jeu de donn√©es [lien](https://github.com/thibautizard/td_statcraft/raw/main/td.zip)

## Mise en place

__Je te conseille de cr√©er (√† l'endroit qui te convient le mieux) un dossier intitul√© Statcraft__ dans lequel tu mettras tous tes programmes R et tes donn√©es.

__D√©zippe le fichier _zip___ que tu as t√©l√©charg√© dans ce dossier Statcraft (`Clic droit` > `7zip` > `Extraire Ici`). Tu te retrouves alors avec un fichier `td.R` et un dossier `data` dont les fichiers ont tous pour extension _.rds_.

__Ouvre `td.R` en double-cliquant dessus__. Rstudio devrait se lancer et t'afficher directement le contenu du fichier.

Avant toute chose, on va __installer les packages__ qui t'aideront √† manipuler tes donn√©es tout au long de ce stage. Les packages sont des extensions de R qui contiennent des fonctions sp√©cifiques pr√™tes √† l'emploi (ce qui nous √©vite surtout de devoir les inventer nous-m√™mes). Pour cela, rends-toi dans la console en bas de Rstudio et tape la commande suivante :

```{r, eval=FALSE}
install.packages(dplyr)
```

Je te laisse faire de m√™me pour les packages `data.table`, `lubridate` et `stringr`. C'est de l'apprentissage par r√©p√©tition üòâ

Une fois ces installations termin√©es, il convient de __mettre en t√™te de ton script l'appel √† ces diff√©rents packages__ afin qu'ils soient inclus d'office dans ton programme lorsque tu l'ex√©cuteras. Pour appeler un package, on utilise la fonction `library`. Par exemple, pour utiliser `dplyr` :

```{r, eval=FALSE}
library(dplyr)
```

Tu te demandes peut-√™tre pourquoi j'alterne entre la console de Rstudio et le script R pour √©crire ces lignes de commande ? Il faut clarifier la distinction entre ces deux espaces. Dans mon script je peux √©crire et sauvegarder pour plus tard une s√©rie de commandes R. Je peux ensuite ex√©cuter une partie ou l'int√©gralit√© de mon script. La console elle me sert √† ex√©cuter imm√©diatemment des lignes de code. Tout est perdu une fois Rstudio referm√© ! Elle est donc utile pour d√©bugguer nos programmes en testant certaines op√©rations ou pour r√©aliser des t√¢ches ponctuelles qui ne reviennent pas r√©guli√®rement. Par exemple, l'installation des packages n√©cessaires sur ton ordinateur ne doit √™tre faite qu'une seule fois. Il n'y aurait pas d'int√©r√™t √† les relancer √† chaque fois que tu ex√©cuteras `td.R` (sauf si tu aimes contempler ton √©cran en attendant). En revanche, l'appel des packages doit √™tre r√©it√©r√© √† chaque fois qu'on utilise un script contenant des fonctions de ce package. C'est pour cela qu'il faut veiller √† avoir une succession de `library(nom_du_package)` au commencement de son fichier si on veut pouvoir acc√©der √† ses fonctions par la suite.

![Interface Rstudio](assets/rstudio.png "Interface Rstudio"){width="100%"}

Il y a un second et dernier pr√©alable pour partir du bon pied, c'est l'indication de ton r√©pertoire de travail ou _working directory_. Lorsque R doit aller chercher des donn√©es sauvegard√©es sur notre PC, par exemple, il lui faut d√©finir un point de d√©part puis les diff√©rents dossiers qu'il devra traverser pour atteindre ces donn√©es. Par d√©faut, lorsque j'ouvre un fichier R dans une nouvelle session Rstudio, celle-ci prend automatiquement pour _working directory_ le dossier qui contient ce fichier. Tu peux v√©rifier le _working directory_ de ta session en cours avec la commande suivante :

```{r}
getwd()
```

Si tu as correctement ouvert le fichier, tu devrais voir appara√Ætre le chemin de ton _working directory_ entrecoup√© de `/` et se terminant par le nom de ton dossier _Statcraft_. C'est un chemin absolu qui sera toujours identifi√© par opposition aux chemins relatifs plus courts √† √©crire mais qui n√©cessitent de partir du bon _working directory_. Pour √©viter que d'aventure R ne se perde, il est recommand√© d'inscrire au d√©but de notre script l'adresse du _working directory_ qu'on souhaite toujours utiliser (surtout si tous nos chemins d'acc√®s aux donn√©es seront √©crits en r√©f√©rence √† celui-ci !). Il te faut donc copier-coller ce chemin (guillemets compris) et l'ins√©rer dans la fonction `setwd()` que tu laisseras elle toujours au d√©but de ton script.

```{r, eval=FALSE}
setwd("mon_chemin/statcraft")
```

Voil√† pour le plus p√©nible. On peut passer au dur de Statcraft üôÖ

## Exploration des donn√©es

Nous allons commencer par importer un tableau initial simplifi√© de Statcraft et nous amuser √† le filtrer et r√©aliser quelques op√©rations de comptage √† l'aide des fonctions du package `dplyr`.

R est √©quip√© de plusieurs fonctions d'importation des donn√©es en fonction du type de donn√©es. Ici nous allons travailler sur des donn√©es de type rds, un format compact et sp√©cifique √† R que j'ai choisi pour sauvegarder les donn√©es en sortie de batchs. Nous allons donc utiliser la fonction `readRDS` pour atteindre un des fichiers stock√©s dans mon dossier `data`.

Je te conseille de t'entra√Æner √† la console avant d'√©crire proprement ton code dans le script. `readRDS` prend un seul argument, le chemin complet menant au fichier .rds que je souhaite lire. Rappelle-toi que nous avons d√©fini notre _working directory_ sur notre dossier `Statcraft` donc je peux faire d√©buter mon chemin en partant de ce point. Un chemin est une succession de dossier s√©par√©s par des `/`. Par exemple `dossier/sous-dossier/fichier.txt`. Le fichier que je souhaite explorer s'appelle `tableau_initial_7_janvier_2022.rds` et se trouve dans le dossier `data`. √Ä quoi pourrait ressembler le chemin de ce fichier ? 

‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è

Je ne te donne pas la solution üòõ, tu peux tester plusieurs combinaisons dans la console jusqu'√† ce qu'apparaisse un gros tableau dans celle-ci. Cela signifiera que le fichier a √©t√© trouv√© et est bien lu. Mais tout cela est √©vanescent, sit√¥t le fichier appel√© et affich√© dans ma console qu'il est d√©j√† reparti loin de Rstudio üò¢ Pour maintenir ces donn√©es dans notre session, il faut les assigner √† une variable que je pourrai ensuite invoquer et modifier √† loisir. Pour assigner des donn√©es √† une variable, j'utilise la fl√®che d'assignation `<-` (le `=` marche aussi).

```{r, eval=FALSE}
data <- readRDS("dossier/sous-dossier/fichier.txt")
```



